name: Continuous Deployment to Cloud Run

on:
  workflow_dispatch:
    inputs:
      environment:
        type: choice
        description: Target deployment environment
        required: true
        default: 'Deployment'
        options:
        - Deployment
        - GoogleCloudRun
        - staging
        - production

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    env:
      PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      SERVICE_NAME: ${{ secrets.CLOUD_RUN_SERVICE }}
      REGION: ${{ secrets.CLOUD_RUN_REGION }}
      REPO: ${{ secrets.ARTIFACT_REGISTRY_REPO }}
      # Defines the full path for the Docker image using the commit SHA as a version tag
      IMAGE: ${{ secrets.CLOUD_RUN_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ secrets.ARTIFACT_REGISTRY_REPO }}/${{ secrets.CLOUD_RUN_SERVICE }}:${{ github.sha }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. Authenticate to Google Cloud using the SA key secret
      - name: Authenticate Google Cloud
        uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      # 2. Set up gcloud and configure Docker for Artifact Registry
      - name: Configure Docker
        run: |
          gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

      # 3. Build and Push the Docker image
      - name: Build and Push Docker Image
        run: |
          docker build -t ${{ env.IMAGE }} .
          docker push ${{ env.IMAGE }}

      # 4. Deploy the image to Cloud Run
      - name: Deploy to Cloud Run
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.SERVICE_NAME }}
          region: ${{ env.REGION }}
          image: ${{ env.IMAGE }}
          # Example flag to allow public access (unauthenticated)
          # flags: --allow-unauthenticated
